---
title: "Ladok Resultat"
author: "Jonas Björnerstedt"
date: '`r Sys.Date()`'
output: 
    pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(lubridate)
load(file = "~/Library/Mobile Documents/com~apple~CloudDocs/Work/data/admin/ladok.Rdata")

andelar = kursresult %>% 
    group_by(kursnamn, termindatum, betyg) %>% 
    summarise(antal = n()) %>% 
    group_by(kursnamn, termindatum) %>% 
    mutate(
        andel = antal / sum(antal) * 100,
        betyg = factor(betyg, levels = c("U","VG","G"))
    ) %>% 
    filter( year(termindatum) < 2017)

godk_program = kursresult %>% 
    mutate(programstudent = !is.na(progr)) %>% 
    group_by(kursnamn, akademiskt_ar, betyg, programstudent) %>% 
    summarise(antal = n()) %>% 
    group_by(kursnamn, akademiskt_ar, programstudent) %>% 
    mutate(
        totantal = sum(antal),
        andel = (1 - antal / sum(antal)) * 100
        ) %>% 
    filter(betyg == "U", akademiskt_ar < 2017)

```

## Registrerade studenter

Antalet studenter per akademiskt år är relativt konstant över tiden, med en ökning på ungefär 20 studenter.

```{r}
kursresult %>% 
    filter(akademiskt_ar < 2017) %>% 
    group_by(akademiskt_ar) %>% 
    summarise(antal = n()) %>% 
    ggplot(aes(akademiskt_ar, antal)) + geom_line()  + geom_smooth(se = FALSE, method = "lm") + labs(title = "Registerade studenter")

```

## Studenter per kurs

Andelen som läser på A nivå minskar sakta över tiden.

```{r}
kursresult %>% 
    filter(akademiskt_ar < 2017) %>% 
    group_by(kursnamn, akademiskt_ar) %>% 
    summarise(antal = n()) %>% 
    ggplot(aes(akademiskt_ar, antal, color = kursnamn)) + geom_line() + labs(title = "Registerade studenter per kurs")

```

## Programstudenter

Andelen programstudenter har minskat. Fler läser enstaka kurs.

```{r}
godk_program %>% 
    filter(kursnamn == "Economics A") %>% 
    ggplot(aes(akademiskt_ar, totantal, color = programstudent)) + geom_line() + labs(title = "Antal studenter A kurs")

```

## Programstudenter lyckas bättre

Programstudenter lyckas väsentligt bättre i sina studier.

```{r}
godk_program %>% 
    filter(kursnamn == "Economics A") %>% 
    ggplot(aes(akademiskt_ar, andel, color = programstudent)) + geom_line() + labs(title = "Andel godkända studenter A kurs")

```


## Studietid

Det tar lång tid att läsa.

Notera att det finns `r kursresult %>% filter(betyg != "U", kursnamn == "Economics A", duration < 0) %>% tally` studenter med slutdatum (idatum i godkkurs) före startdatum (idatum i ffgkurs)

```{r}
kursresult %>% 
    filter(betyg != "U", kursnamn == "Economics B", duration > 0) %>% 
    # group_by(kursnamn ) %>% 
    mutate(duration = duration / 365) %>% 
    ggplot(aes(duration)) + 
        geom_histogram(binwidth = 0.5, center = 0.25) + 
        labs(title = "Studietid A kurs", x = "År", y = "Andel" ) + scale_x_continuous(breaks = 1:10)
```

## Economics A - Kursresultat

```{r}
andelar %>% 
    filter(kursnamn == "Economics A") %>% 
    ggplot(aes(termindatum, antal, color = betyg )) + 
    geom_line() + labs(title = "Antal godkänd A kurs", x ="Starttermin")

```

## Economics A - Andelar

```{r}
andelar %>% 
    filter(kursnamn == "Economics A") %>% 
    ggplot(aes(termindatum, andel, fill = betyg )) + 
    geom_area(alpha = 0.6) + labs(title = "Andel godkänd A kurs")

```

## Economics B - Kursresultat

```{r}
andelar %>% 
    filter(kursnamn == "Economics B") %>% 
    ggplot(aes(termindatum, antal, color = betyg )) + 
    geom_line() + labs(title = "Antal godkänd B kurs")

```

## Economics B - Andelar

```{r}
andelar %>% 
    select(-antal) %>% 
    filter(kursnamn == "Economics B") %>% 
    spread(key = betyg, value = andel, fill = 0) %>% 
    gather(betyg, andel,-kursnamn, -termindatum) %>% 
    mutate(
        betyg = factor(betyg, levels = c("U","VG","G"))
    ) %>% 
    ggplot(aes(termindatum, andel, fill = betyg )) + 
    geom_area(alpha = 0.6) + labs(title = "Andel godkänd B kurs")

```

## Economics C - Kursresultat

```{r}
andelar %>% 
    filter(kursnamn == "Economics C") %>% 
    ggplot(aes(termindatum, antal, color = betyg )) + 
    geom_line() + labs(title = "Antal godkänd C kurs")

```

## Economics C - Andelar

```{r}
andelar %>% 
    select(-antal) %>% 
    filter(kursnamn == "Economics C") %>% 
    spread(key = betyg, value = andel, fill = 0) %>% 
    gather(betyg, andel,-kursnamn, -termindatum) %>% 
    mutate(
        betyg = factor(betyg, levels = c("U","VG","G"))
    ) %>% 
    ggplot(aes(termindatum, andel, fill = betyg )) + 
    geom_area(alpha = 0.6) + labs(title = "Andel godkänd C kurs")

```

## Vilka B/C kurser läser studenter?

Totalt `r godkprov %>% filter(kursnamn != "Economics A") %>% tally() %>% as.numeric()` godkända studenter. Antal godkända per kurs under akademiska åren 2015 och 2016.

```{r}
library(knitr)
library(stringr)
godkprov %>% 
    filter(kursnamn != "Economics A", akademiskt_ar == 2015 | akademiskt_ar == 2016) %>% 
    mutate(delkurs = str_replace(delkurs, " 1", "")) %>% 
    group_by(delkurs, kursnamn) %>% 
    summarise(antal = n()) %>% 
    spread(kursnamn, antal, fill = 0) %>% 
    mutate(Totalt = `Economics B` + `Economics C` ) %>% 
    arrange(-Totalt) %>% 
    kable()
```

## Uppsats

```{r}
uppsats_tid = godkprov %>% 
    filter(delkurs == "Essay") %>% 
    mutate(
        veckor = duration / 7,
        mer_ar = duration > 365
        ) 

andel_mer = uppsats_tid %>% group_by(mer_ar) %>% summarise(antal = n()) %>% mutate(andel = antal/sum(antal))

uppsats_tid %>% 
    ggplot(aes(veckor)) + geom_histogram(binwidth = 10, center = 5) + labs(title = "Antal veckor för uppsats")
```

För `r round(andel_mer$andel[andel_mer$mer_ar]*100,1)` procent av studenterna tog det mer än ett år att bli färdig.
